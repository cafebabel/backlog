{% extends 'base.html' %}

{% block body %}
{% block body_class %}profile{% endblock %}
{% if user.profile %}
<h1>{{ user }}'s profile</h1>
{% else %}
<h1>Create a profile</h1>
{% endif %}

  <section>
    <h2>About</h2>
    <img src=https://rawgit.com/cafebabel/styleguide/master/img/profile-pic-placeholder.jpg alt="Profile pic placeholder" class=profile-pic> <!-- #US14 https://github.com/cafebabel/cafebabel.com/issues/14 -->
      <ul>
          <li class=icon-twitter>Twitter<a data-edit-name=socials-twitter href="{{ user.profile.socials.twitter }}"></a></li>
          <li class=icon-facebook>Facebook<a data-edit-name=socials-facebook href="{{ user.profile.socials.facebook }}"></a></li>
          <li class=icon-instagram>Instagram<a data-edit-name=socials-instagram href="{{ user.profile.socials.instagram }}"></a></li>
          <li class=icon-medium>Medium<a data-edit-name=socials-medium href="{{ user.profile.socials.medium }}"></a></li>
          <li class=icon-flickr2>Flickr<a data-edit-name=socials-flickr href="{{ user.profile.socials.flickr }}"></a></li>
          <li class=icon-pinterest2>Pinterest<a data-edit-name=socials-pinterest href="{{ user.profile.socials.pinterest }}"></a></li>
      </ul>
      <ul>
      <li><h3>Full name:</h3><span data-edit-name=name data-edit-attrs="required">{{ user.profile.name or '' }}</span></li>
      <li><h3>Website:</h3><span data-edit-name=website data-edit-attrs="type=url"><a href="{{ user.profile.website or '' }}" target=_blank>{{ user.profile.website or '' }}</a></span></li>
      <li>
        <h3>Bio:</h3>
            <p>
                <span data-edit-name=about data-edit-type=textarea>{{ user.profile.about or '' }}</span>
            </p>
      </li>
    </ul>




{% if edit %}
  {% if user.has_role('editor') %}
    <div class=checkbox>
      <label for=editor>Editor role</label>
      <input type=checkbox id=editor name=editor value=1 {% if user.has_role('editor', False) %}checked{% endif %}>
    </div>
  {% endif %}
  <form class=user-save data-method=put action={{ url_for('api_user_put') }}>
    <button type=submit>Save my profile</button>
  </form>

  <form class=user-delete data-method=delete action={{ url_for('api_user_delete', id=user.idstr) }}>
    <button type=submit>Delete my profile</button>
  </form>

  </section>
  <section>
    <h2>Contributions</h2>
  </section>

    <script>
      function dataEditInput(editable) {
        const type = editable.dataset.editType && `type=${editable.dataset.editType}`
        editable.innerHTML = `
          <input data-edit
            ${type}
            name="${editable.dataset.editName}"
            value="${editable.textContent || ''}"
            ${editable.dataset.editAttrs}
            >
        `
      }

      const fields = Array.from(document.querySelectorAll('[data-edit]'))
      const data = {
        'name': fields.find(f => f.name === 'name').value.trim(),
        'website': fields.find(f => f.name === 'website').value.trim(),
        'about': fields.find(f => f.name === 'about').value.trim(),
        'socials': {},
        // 'is_editor': document.querySelector('[name=editor]').checked,
      }
      Array.from(document.querySelectorAll('[data-edit-name]')).forEach(editable => {
        const type = editable.dataset.editType || 'input'
        const funcName = `dataEdit${type[0].toUpperCase()}${type.slice(1)}`
        this[funcName] ? this[funcName](editable) : dataEditInput(editable)
      })

      document.querySelector('.user-save').addEventListener('submit', event => {
        event.preventDefault()

        const fields = Array.from(document.querySelectorAll('[data-edit]'))
        const data = {
          'name': fields.find(f => f.name === 'name').value.trim(),
          'website': fields.find(f => f.name === 'website').value.trim(),
          'about': fields.find(f => f.name === 'about').value.trim(),
          'socials': {},
        }
        fields.filter(f => f.name.slice(0, 8) === 'socials-').forEach(input => {
          data['socials'][input.name.slice(8)] = input.value.trim()
        })

        request(event.target.action, {
          method: event.target.dataset.method || event.target.method,
          body: data,
        })
        .then(r => location.href = `/profile/${r.id}/`)
        .catch(e => alert(e.error))
      })

      const deleteForm = document.querySelector('.user-delete')
      deleteForm && deleteForm.addEventListener('submit', event => {
        event.preventDefault()
        const confirmed = confirm('Are you sure you want to delete your account?')
        if (!confirmed) return

        request(event.target.action, {method: event.target.dataset.method})
        .then(r => {
          console.info('user deleted')
          location.href = '/'
        })
        .catch(e => alert(e.error))
      })
    </script>
  {% endif %}

{% endblock %}
